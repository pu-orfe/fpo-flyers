name: Generate FPO Flyers

on:
  workflow_dispatch:
    inputs:
      force:
        description: "Force regeneration (skip change detection)"
        required: false
        default: "false"
        type: boolean
  schedule:
    # Weekdays at noon UTC
    - cron: "0 12 * * 1-5"

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  # ── Lightweight change detection (no Python, no deps) ──────────
  check:
    if: ${{ inputs.force != true }}
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.hash.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check feed for changes
        id: hash
        env:
          ICS_FEED_URL: ${{ vars.ICS_FEED_URL }}
        run: |
          FEED_URL="${ICS_FEED_URL:-https://orfe.princeton.edu/feeds/events/ical.ics?tid=491}"
          # Hash must match Python's compute_feed_hash():
          #   filter DTSTAMP lines, strip \r, join with \n (no trailing newline), SHA-256
          CURRENT=$(curl -fsSL "$FEED_URL" | tr -d '\r' | grep -v '^DTSTAMP' | perl -pe 'chomp if eof' | sha256sum | cut -d' ' -f1)
          STORED=""
          if [ -f .feed_hash ]; then
            STORED=$(tr -d '[:space:]' < .feed_hash)
          fi
          echo "current=$CURRENT"
          echo "stored=$STORED"
          if [ "$CURRENT" = "$STORED" ]; then
            echo "Feed unchanged"
            echo "changed=false" >> "$GITHUB_OUTPUT"
          else
            echo "Feed changed"
            echo "changed=true" >> "$GITHUB_OUTPUT"
          fi

  # ── Full generation (only when feed changed or force) ──────────
  generate:
    needs: check
    if: ${{ always() && (needs.check.outputs.changed == 'true' || needs.check.result == 'skipped') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            libpango-1.0-0 libpangocairo-1.0-0 \
            libgdk-pixbuf-2.0-0 libffi-dev libcairo2 \
            fonts-liberation

      - name: Install Python dependencies
        run: pip install ".[test]"

      - name: Run unit tests
        run: python -m pytest tests/unit/ -v

      - name: Generate flyers
        id: generate
        env:
          ICS_FEED_URL: ${{ vars.ICS_FEED_URL }}
          BYPASS_HEADER: ${{ secrets.BYPASS_HEADER }}
        run: |
          set -- --output-dir output --verbose --force
          if [ -n "$ICS_FEED_URL" ]; then
            set -- "$@" --feed-url "$ICS_FEED_URL"
          fi
          if [ -n "$BYPASS_HEADER" ]; then
            set -- "$@" --bypass-header "$BYPASS_HEADER"
          fi
          fpo-flyers "$@"
          # Check if any PDFs were generated
          if ls output/*.pdf 1>/dev/null 2>&1; then
            echo "has_pdfs=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_pdfs=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit hash file
        if: steps.generate.outputs.has_pdfs == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .feed_hash
          git diff --cached --quiet || git commit -m "[skip ci] Update feed hash"
          git push

      - name: Build site
        if: steps.generate.outputs.has_pdfs == 'true'
        run: |
          mkdir -p _site
          cp docs/index.html _site/
          cp docs/style.css _site/
          cp output/*.pdf _site/
          # Generate a JSON manifest of PDFs for the index page
          cd _site
          echo "[" > manifest.json
          first=true
          for f in *.pdf; do
            [ "$f" = "*.pdf" ] && break
            if [ "$first" = true ]; then first=false; else echo "," >> manifest.json; fi
            echo "  \"$f\"" >> manifest.json
          done
          echo "]" >> manifest.json

      - name: Upload Pages artifact
        if: steps.generate.outputs.has_pdfs == 'true'
        uses: actions/upload-pages-artifact@v3

      - name: Deploy to GitHub Pages
        if: steps.generate.outputs.has_pdfs == 'true'
        uses: actions/deploy-pages@v4
